# Court Scheduler Workflow
name: Court Scheduler

on:
  # 매일 한국시간 08:55에 실행 (UTC 23:55 전날)
  # GitHub Actions는 정확한 시간에 실행되지 않을 수 있으므로 여유를 둠
  schedule:
    - cron: '55 23 * * *'
  
  # 수동 실행 지원
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  reserve:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: Install system dependencies for OCR
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-eng
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify installations
        run: |
          google-chrome --version
          chromedriver --version
          tesseract --version
          python -c "import ddddocr; print('ddddocr OK')"
          python -c "import easyocr; print('easyocr OK')"
      
      - name: Run reservation bot
        env:
          LOGIN_ID: ${{ secrets.LOGIN_ID }}
          LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
          LOGIN_URL: ${{ secrets.LOGIN_URL }}
          BASE_URL: ${{ secrets.BASE_URL }}
          SLACK_URL: ${{ secrets.SLACK_URL }}
        run: |
          python -m src.main
      
      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: /tmp/*.png
          retention-days: 7
          if-no-files-found: ignore
