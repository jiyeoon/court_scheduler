# Court Scheduler Workflow
name: Court Scheduler

on:
  # ë§¤ì¼ í•œêµ­ì‹œê°„ 08:45ì— ì‹¤í–‰ (UTC 23:45 ì „ë‚ )
  # GitHub ActionsëŠ” 5-15ë¶„ ì§€ì—°ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë„‰ë„‰íˆ ì—¬ìœ ë¥¼ ë‘ 
  schedule:
    - cron: '50 23 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  reserve:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    continue-on-error: true  # ì‹¤íŒ¨í•´ë„ ì´ë©”ì¼ ì•Œë¦¼ ì•ˆ ë³´ëƒ„ (Slackìœ¼ë¡œ ëŒ€ì²´)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: Install system dependencies for OCR
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-eng
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify installations
        run: |
          google-chrome --version
          chromedriver --version
          tesseract --version
          python -c "import ddddocr; print('ddddocr OK')"
          python -c "import easyocr; print('easyocr OK')"
      
      - name: Measure RTT to server
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
        run: |
          python -c "
          import os, time, requests
          from statistics import mean, stdev
          url = os.environ.get('BASE_URL', '')
          if not url:
              print('BASE_URL not set')
              exit(0)
          rtts = []
          print('ğŸ” RTT ì¸¡ì • ì‹œì‘ (5íšŒ)')
          for i in range(5):
              start = time.perf_counter()
              try:
                  requests.get(url, timeout=10)
                  rtt = (time.perf_counter() - start) * 1000
                  rtts.append(rtt)
                  print(f'  ìš”ì²­ {i+1}: {rtt:.0f}ms')
              except Exception as e:
                  print(f'  ìš”ì²­ {i+1}: ì‹¤íŒ¨')
              time.sleep(0.3)
          if rtts:
              print(f'ğŸ“Š RTT ê²°ê³¼: í‰ê·  {mean(rtts):.0f}ms, ìµœì†Œ {min(rtts):.0f}ms, ìµœëŒ€ {max(rtts):.0f}ms')
              print(f'ğŸ’¡ ê¶Œì¥ PRE_REFRESH_MS: {mean(rtts):.0f}ms')
          "
      
      - name: Run reservation bot
        env:
          LOGIN_ID: ${{ secrets.LOGIN_ID }}
          LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
          LOGIN_URL: ${{ secrets.LOGIN_URL }}
          BASE_URL: ${{ secrets.BASE_URL }}
          SLACK_URL: ${{ secrets.SLACK_URL }}
        run: |
          python -m src.main
      
      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: /tmp/*.png
          retention-days: 7
          if-no-files-found: ignore
